<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>환자 관리</title>
    <link type="text/css" th:href="@{/css/staffCommon.css}" rel="stylesheet">
    <link type="text/css" th:href="@{/css/staffPatient.css}" rel="stylesheet">
</head>
<body>

    <nav class="sidebar">
        <h2>EMR (STAFF)</h2>
        <ul>
            <li><a href="/staff/">접수/예약</a></li>
            <li><a href="/staff/payment">수납 관리</a></li>
            <li><a href="/staff/patients"><b>환자 관리</b></a></li>
            <li><a href="/user/logout">로그아웃</a></li>
        </ul>
    </nav>

    <main class="content">
        <h1>전체 환자 관리</h1>
        <p>병원의 모든 환자 목록을 조회하고 관리합니다.</p>
        <hr>

        <input type="text" id="patientSearchInput" placeholder="환자명/차트번호 검색..." style="padding: 10px; width: 300px;">
        
        <table>
            <thead>
                <tr>
                    <th>차트번호</th>
                    <th>환자명</th>
                    <th>연락처</th>
                    <th>생년월일</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody id="patientTableBody">
                <tr th:each="patient : ${patientList}">
                    <td th:text="${patient.chartNum}"></td>
                    <td th:text="${patient.name}"></td>
                    <td th:text="${patient.phone}"></td>
                    <td th:text="${patient.birth}"></td>
                    <td>
                        <button class="btn">상세/수정</button>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(patientList)}">
                    <td colspan="5" style="text-align: center;">등록된 환자가 없습니다.</td>
                </tr>
            </tbody>
        </table>
    </main>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <script>
        $(document).ready(function() {
            var debounceTimer;

            $("#patientSearchInput").on("keyup", function() {
                clearTimeout(debounceTimer);
                var query = $(this).val();

                // 300ms 지연 후 검색 API 호출
                debounceTimer = setTimeout(function() {
                    $.ajax({
                        type: "GET",
                        // (참고) 대시보드에서 사용한 검색 API와 동일한 URL 사용
                        url: "/staff/search", 
                        data: { query: query }, // ?query=...
                        success: function(patients) {
                            var tableBody = $("#patientTableBody");
                            tableBody.empty(); // 1. 기존 테이블 내용 삭제

                            if (patients.length === 0) {
                                // 2. 검색 결과가 없을 경우
                                tableBody.append(
                                    '<tr><td colspan="5" style="text-align: center;">검색된 환자가 없습니다.</td></tr>'
                                );
                            } else {
                                // 3. 검색 결과로 테이블 행(tr) 재생성
                                patients.forEach(function(p) {
                                    var row = `
                                        <tr>
                                            <td>${p.chartNum}</td>
                                            <td>${p.name}</td>
                                            <td>${p.phone}</td>
                                            <td>${p.birth}</td>
                                            <td><button class="btn">상세/수정</button></td>
                                        </tr>
                                    `;
                                    tableBody.append(row);
                                });
                            }
                        },
                        error: function() {
                            var tableBody = $("#patientTableBody");
                            tableBody.empty();
                            tableBody.append(
                                '<tr><td colspan="5" style="text-align: center;">검색 중 오류가 발생했습니다.</td></tr>'
                            );
                        }
                    });
                }, 300); 
            });
        });
    </script>
</body>
</html>