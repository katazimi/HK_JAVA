<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>환자 관리</title>
    <link type="text/css" th:href="@{/css/staffCommon.css}" rel="stylesheet">
    <link type="text/css" th:href="@{/css/staffPatient.css}" rel="stylesheet">
    </head>
<body>

    <nav class="sidebar">
        <h2>EMR (STAFF)</h2>
        <ul>
            <li><a href="/staff/">접수/예약</a></li>
            <li><a href="/staff/payment">수납 관리</a></li>
            <li><a href="/staff/patients"><b>환자 관리</b></a></li>
            <li><a href="/user/logout">로그아웃</a></li>
        </ul>
    </nav>

    <main class="content">
        <h1>전체 환자 관리</h1>
        <p>병원의 모든 환자 목록을 조회하고 관리합니다.</p>
        <hr>

        <input type="text" id="patientSearchInput" placeholder="환자명/차트번호 검색..." style="padding: 10px; width: 300px;">
        
        <table>
            <thead>
                <tr>
                    <th>차트번호</th>
                    <th>환자명</th>
                    <th>연락처</th>
                    <th>생년월일</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody id="patientTableBody">
                <tr th:each="patient : ${patientList}">
                    <td th:text="${patient.chartNum}"></td>
                    <td th:text="${patient.name}"></td>
                    <td th:text="${patient.phone}"></td>
                    <td th:text="${patient.birth}"></td>
                    <td>
                        <button class="btn"
                                th:data-patient-id="${patient.patientId}"
                                th:data-chart-num="${patient.chartNum}"
                                th:data-name="${patient.name}"
                                th:data-phone="${patient.phone}"
                                th:data-birth="${patient.birth}"
                                onclick="openUpdateModal(this)">
                            상세/수정
                        </button>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(patientList)}">
                    <td colspan="5" style="text-align: center;">등록된 환자가 없습니다.</td>
                </tr>
            </tbody>
        </table>
    </main>
    
    <div id="modal-update-patient" class="modal">
        <div class="modal-content">
            <h2>환자 정보 수정</h2>
            <form id="updatePatientForm">
                <input type="hidden" id="update_patientId" name="patientId">
                
                <label>차트번호:</label>
                <input type="text" id="update_chartNum" class="form-control" readonly disabled>

                <label>환자명:</label>
                <input type="text" id="update_name" name="name" class="form-control" required>

                <label>연락처:</label>
                <input type="text" id="update_phone" name="phone" class="form-control">

                <label>생년월일(YYYYMMDD):</label>
                <input type="text" id="update_birth" name="birthDate" class="form-control">

                <button type="submit" class="btn">저장</button>
                <button type="button" class="btn btn-danger" onclick="closeUpdateModal()">취소</button>
            </form>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <script>
        const updateModal = document.getElementById('modal-update-patient');
        
        function openUpdateModal(button) {
            // 클릭한 버튼(this)의 data-* 속성에서 값을 읽어옴
            var patientId = button.dataset.patientId;
            var chartNum = button.dataset.chartNum;
            var name = button.dataset.name;
            var phone = button.dataset.phone;
            var birth = button.dataset.birth;
            
            // 모달 폼에 값 채우기
            $("#update_patientId").val(patientId);
            $("#update_chartNum").val(chartNum);
            $("#update_name").val(name);
            $("#update_phone").val(phone);
            $("#update_birth").val(birth);
            
            // 모달 열기
            updateModal.style.display = 'flex';
        }
        
        function closeUpdateModal() {
            updateModal.style.display = 'none';
        }
    </script>
    
    <script>
        $(document).ready(function() {
            var debounceTimer;

            // --- 1. 실시간 검색 (keyup) ---
            $("#patientSearchInput").on("keyup", function() {
                clearTimeout(debounceTimer);
                var query = $(this).val();

                debounceTimer = setTimeout(function() {
                    $.ajax({
                        type: "GET",
                        url: "/staff/search", 
                        data: { query: query }, 
                        success: function(patients) {
                            var tableBody = $("#patientTableBody");
                            tableBody.empty(); 

                            if (patients.length === 0) {
                                tableBody.append(
                                    '<tr><td colspan="5" style="text-align: center;">검색된 환자가 없습니다.</td></tr>'
                                );
                            } else {
                                patients.forEach(function(p) {
                                    // [수정] 검색 결과 행(row)에도 data-* 속성과 onclick 추가
                                    var row = `
                                        <tr>
                                            <td>${p.chartNum}</td>
                                            <td>${p.name}</td>
                                            <td>${p.phone}</td>
                                            <td>${p.birth}</td>
                                            <td>
                                                <button class="btn"
                                                        data-patient-id="${p.patientId}"
                                                        data-chart-num="${p.chartNum}"
                                                        data-name="${p.name}"
                                                        data-phone="${p.phone}"
                                                        data-birth="${p.birth}"
                                                        onclick="openUpdateModal(this)">
                                                    상세/수정
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                    tableBody.append(row);
                                });
                            }
                        },
                        error: function() {
                            // (오류 처리 동일)
                            var tableBody = $("#patientTableBody");
                            tableBody.empty();
                            tableBody.append(
                                '<tr><td colspan="5" style="text-align: center;">검색 중 오류가 발생했습니다.</td></tr>'
                            );
                        }
                    });
                }, 300); 
            });
            
            // --- 2. [추가] '환자 수정' 폼 제출 (submit) ---
            $("#updatePatientForm").on("submit", function(e) {
                e.preventDefault();
                
                var formData = {
                    patientId: $("#update_patientId").val(), // (PK)
                    name: $("#update_name").val(),
                    phone: $("#update_phone").val(),
                    birth: $("#update_birth").val() 
                };
                
                $.ajax({
                    type: "POST", 
                    url: "/staff/update", 
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function(response) {
                        alert("환자 정보가 수정되었습니다.");
                        closeUpdateModal();
                        location.reload(); // (목록 새로고침)
                    },
                    error: function(xhr) {
                        alert(xhr.responseJSON.message || "수정에 실패했습니다.");
                    }
                });
            });
            
        });
    </script>
</body>
</html>