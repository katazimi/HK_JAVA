<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ï£ºÏãù Ï∞®Ìä∏</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* Í≤ÄÏÉâÏ∞Ω */
        .search-wrapper { position: relative; width: 100%; max-width: 400px; margin: 0 auto 20px auto; z-index: 20; }
        #searchInput { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        #searchResult { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 5px 5px; max-height: 250px; overflow-y: auto; list-style: none; padding: 0; margin: 0; z-index: 1000; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #searchResult li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        #searchResult li:hover { background-color: #f5f5f5; }

        /* Ï†ïÎ≥¥ ÌëúÏãúÏ§Ñ (Info Bar) */
        #chartLegend {
            width: 100%;
            min-height: 50px; 
            margin-bottom: 10px; 
            padding: 10px 15px;
            background-color: #fafafa; 
            border: 1px solid #eee;
            border-radius: 5px;
            box-sizing: border-box;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        .stock-title { font-size: 28px; font-weight: bold; margin-right: 20px; color: #000; }
        .legend-item { display: flex; align-items: center; }
        .legend-label { margin-right: 4px; color: #666; }
        .legend-value { font-weight: bold; }
        .up { color: #FF0000; }
        .down { color: #0000FF; }

        #tv_chart { width: 100%; height: 600px; }

        /* ‚≠êÔ∏è Ìå®ÌÑ¥ Î∂ÑÏÑù Í≤∞Í≥º ÏòÅÏó≠ Ïä§ÌÉÄÏùº (Ïã†Í∑ú Ï∂îÍ∞Ä) */
        #analysisSection {
            margin-top: 30px;
            border-top: 2px solid #f0f0f0;
            padding-top: 20px;
            display: none; /* Î°úÎî© Ï†ÑÏóî Ïà®ÍπÄ */
        }
        .analysis-header { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; }
        .analysis-header::before { content: ''; display: inline-block; width: 4px; height: 18px; background: #2962FF; margin-right: 10px; border-radius: 2px; }
        
        .pattern-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .pattern-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .pattern-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #2962FF; }
        
        .pattern-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pattern-name { font-size: 16px; font-weight: bold; color: #333; }
        
        .trend-badge { font-size: 12px; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
        .trend-up { background-color: #ffebee; color: #c62828; }
        .trend-down { background-color: #e3f2fd; color: #1565c0; }
        .trend-neutral { background-color: #f5f5f5; color: #616161; }

        .pattern-desc { font-size: 13px; color: #666; line-height: 1.5; margin-bottom: 10px; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .pattern-meta { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 10px; font-size: 12px; color: #999; }
        .reliability-stars { color: #ffc107; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="Ï¢ÖÎ™©Î™Ö Í≤ÄÏÉâ (Ïòà: ÏÇºÏÑ±Ï†ÑÏûê)" autocomplete="off">
            <ul id="searchResult"></ul>
        </div>

        <div id="chartLegend">
            <span class="stock-title">ÏÇºÏÑ±Ï†ÑÏûê (005930)</span>
        </div>

        <div id="tv_chart"></div>

        <div id="analysisSection">
            <div class="analysis-header">üìä Ï∫îÎì§ Ìå®ÌÑ¥ Î∂ÑÏÑù Í≤∞Í≥º (ÏµúÍ∑º 3Ïùº)</div>
            <div id="patternList" class="pattern-list"></div>
        </div>
    </div>

    <script>
        // ‚≠êÔ∏è Ìå®ÌÑ¥ Ï†ïÎ≥¥ Îß§Ìïë Îç∞Ïù¥ÌÑ∞
        const PATTERN_DEFINITIONS = {
            // ÏÉÅÏäπÌòï
            "BULLISH_ENGULFING": { name: "ÏÉÅÏäπ Ïû•ÏïÖÌòï", desc: "Ï†ÑÏùº ÏùåÎ¥âÏùÑ Ïò§Îäò ÏñëÎ¥âÏù¥ ÏôÑÏ†ÑÌûà Í∞êÏã∏Îäî Í∞ïÎ†•Ìïú ÏÉÅÏäπ Ïã†Ìò∏ÏûÖÎãàÎã§.", trend: "ÏÉÅÏäπ", stars: 5 },
            "MORNING_STAR": { name: "ÏÉõÎ≥ÑÌòï", desc: "ÌïòÎùΩ‚ÜíÎèÑÏßÄ‚ÜíÏÉÅÏäπÏúºÎ°ú Ïù¥Ïñ¥ÏßÄÎäî 3Ïùº ÏôÑÏÑ±Ìòï Ìå®ÌÑ¥. ÌôïÏã§Ìïú Î∞òÏ†Ñ Ïã†Ìò∏.", trend: "ÏÉÅÏäπ", stars: 5 },
            "THREE_WHITE_SOLDIERS": { name: "Ï†ÅÏÇºÎ≥ë", desc: "ÏñëÎ¥â 3Í∞úÍ∞Ä Ïó∞ÏÜçÌï¥ÏÑú Í≥†Ï†êÏùÑ ÎÜíÏù¥Î©∞ ÏÉÅÏäπÏÑ∏Í∞Ä ÏßÄÏÜçÎê®ÏùÑ ÏïåÎ¶ΩÎãàÎã§.", trend: "ÏÉÅÏäπ", stars: 5 },
            "PIERCING_LINE": { name: "Í¥ÄÌÜµÌòï", desc: "Ï†ÑÏùº Ïû•ÎåÄÏùåÎ¥âÏùò Ï§ëÏã¨ÏÑ† 50% Ïù¥ÏÉÅÏúºÎ°ú ÏñëÎ¥âÏù¥ ÏπòÍ≥† Ïò¨ÎùºÏò® ÌòïÌÉúÏûÖÎãàÎã§.", trend: "ÏÉÅÏäπ", stars: 4 },
            "THREE_INSIDE_UP": { name: "ÏÉÅÏäπ ÏûâÌÉú ÌôïÏù∏Ìòï", desc: "ÌïòÎùºÎØ∏ Î∞úÏÉù ÌõÑ ÏñëÎ¥âÏù¥ Îú®Î©∞ ÏÉÅÏäπ Î∞òÏ†ÑÏùÑ ÌôïÏ†ïÏßÄÏóàÏäµÎãàÎã§.", trend: "ÏÉÅÏäπ", stars: 4 },
            "THREE_OUTSIDE_UP": { name: "ÏÉÅÏäπ Ïû•ÏïÖ ÌôïÏù∏Ìòï", desc: "Ïû•ÏïÖÌòï Î∞úÏÉù ÌõÑ ÏñëÎ¥âÏù¥ Îú®Î©∞ ÏÉÅÏäπ Î∞òÏ†ÑÏùÑ ÌôïÏ†ïÏßÄÏóàÏäµÎãàÎã§.", trend: "ÏÉÅÏäπ", stars: 4 },
            "BULLISH_KICKER": { name: "ÏÉÅÏäπ Î∞ïÏ∞®Ìòï", desc: "ÏùåÎ¥â ÌõÑ Í∞≠ÏÉÅÏäπ Ïû•ÎåÄÏñëÎ¥âÏù¥ Î∞úÏÉùÌïú Í∏âÍ≤©Ìïú ÏÉÅÏäπ Î∞òÏ†Ñ Ïã†Ìò∏ÏûÖÎãàÎã§.", trend: "ÏÉÅÏäπ", stars: 4 },
            "HAMMER": { name: "ÎßùÏπòÌòï", desc: "ÌïòÎùΩ Ï∂îÏÑ∏ Î∞îÎã•ÏóêÏÑú Í∏¥ ÏïÑÎûòÍº¨Î¶¨Í∞Ä Î∞úÏÉù. Ï†ÄÍ∞Ä Îß§ÏàòÏÑ∏ Ïú†ÏûÖ.", trend: "ÏÉÅÏäπ", stars: 3 },
            "INVERTED_HAMMER": { name: "Ïó≠ÎßùÏπòÌòï", desc: "Î∞îÎã•Í∂åÏóêÏÑú Îß§ÏàòÏÑ∏Í∞Ä Ïú†ÏûÖÎêòÎ†§Îäî Ïã†Ìò∏ÏûÖÎãàÎã§.", trend: "ÏÉÅÏäπ", stars: 2 },
            "BULLISH_HARAMI": { name: "ÏÉÅÏäπ ÏûâÌÉúÌòï", desc: "Í∏¥ ÏùåÎ¥â ÏïàÏóê ÏûëÏùÄ ÏñëÎ¥âÏù¥ Í∞áÌûå ÌòïÌÉú. ÌïòÎùΩÏÑ∏Í∞Ä Î©àÏ∂îÍ≥† ÏûàÏäµÎãàÎã§.", trend: "ÏÉÅÏäπ", stars: 2 },
            "WHITE_MARUBOZU": { name: "Ïû•ÎåÄ ÏñëÎ¥â", desc: "ÏúÑÏïÑÎûò Íº¨Î¶¨ ÏóÜÎäî Í∞ïÎ†•Ìïú ÏÉÅÏäπÏÑ∏ÏûÖÎãàÎã§.", trend: "ÏÉÅÏäπ", stars: 3 },

            // ÌïòÎùΩÌòï
            "BEARISH_ENGULFING": { name: "ÌïòÎùΩ Ïû•ÏïÖÌòï", desc: "Ï†ÑÏùº ÏñëÎ¥âÏùÑ Ïò§Îäò ÏùåÎ¥âÏù¥ ÏôÑÏ†ÑÌûà Í∞êÏã∏Îäî Í∞ïÎ†•Ìïú ÌïòÎùΩ Ïã†Ìò∏ÏûÖÎãàÎã§.", trend: "ÌïòÎùΩ", stars: 5 },
            "EVENING_STAR": { name: "ÏÑùÎ≥ÑÌòï", desc: "ÏÉÅÏäπ‚ÜíÎèÑÏßÄ‚ÜíÌïòÎùΩÏúºÎ°ú Ïù¥Ïñ¥ÏßÄÎäî 3Ïùº ÏôÑÏÑ±Ìòï Ìå®ÌÑ¥. ÌôïÏã§Ìïú ÌïòÎùΩ Î∞òÏ†Ñ.", trend: "ÌïòÎùΩ", stars: 5 },
            "THREE_BLACK_CROWS": { name: "ÌùëÏÇºÎ≥ë", desc: "ÏùåÎ¥â 3Í∞úÍ∞Ä Ïó∞ÏÜçÌï¥ÏÑú Ï†ÄÏ†êÏùÑ ÎÇÆÏ∂îÎ©∞ ÌïòÎùΩÏÑ∏Í∞Ä ÏßÄÏÜçÎê®ÏùÑ ÏïåÎ¶ΩÎãàÎã§.", trend: "ÌïòÎùΩ", stars: 5 },
            "DARK_CLOUD_COVER": { name: "ÌùëÏö¥Ìòï", desc: "Ï†ÑÏùº Ïû•ÎåÄÏñëÎ¥âÏùò Ï§ëÏã¨ÏÑ† 50% Ïù¥ÌïòÎ°ú ÏùåÎ¥âÏù¥ ÎÇ¥Î†§ÍΩÇÌûå ÌòïÌÉúÏûÖÎãàÎã§.", trend: "ÌïòÎùΩ", stars: 4 },
            "THREE_INSIDE_DOWN": { name: "ÌïòÎùΩ ÏûâÌÉú ÌôïÏù∏Ìòï", desc: "ÌïòÎùºÎØ∏ Î∞úÏÉù ÌõÑ ÏùåÎ¥âÏù¥ Îú®Î©∞ ÌïòÎùΩ Î∞òÏ†ÑÏùÑ ÌôïÏ†ïÏßÄÏóàÏäµÎãàÎã§.", trend: "ÌïòÎùΩ", stars: 4 },
            "THREE_OUTSIDE_DOWN": { name: "ÌïòÎùΩ Ïû•ÏïÖ ÌôïÏù∏Ìòï", desc: "Ïû•ÏïÖÌòï Î∞úÏÉù ÌõÑ ÏùåÎ¥âÏù¥ Îú®Î©∞ ÌïòÎùΩ Î∞òÏ†ÑÏùÑ ÌôïÏ†ïÏßÄÏóàÏäµÎãàÎã§.", trend: "ÌïòÎùΩ", stars: 4 },
            "BEARISH_KICKER": { name: "ÌïòÎùΩ Î∞ïÏ∞®Ìòï", desc: "ÏñëÎ¥â ÌõÑ Í∞≠ÌïòÎùΩ Ïû•ÎåÄÏùåÎ¥âÏù¥ Î∞úÏÉùÌïú Í∏âÍ≤©Ìïú ÌïòÎùΩ Î∞òÏ†Ñ Ïã†Ìò∏ÏûÖÎãàÎã§.", trend: "ÌïòÎùΩ", stars: 4 },
            "SHOOTING_STAR": { name: "Ïú†ÏÑ±Ìòï", desc: "Í≥†Ï†êÏóêÏÑú Í∏¥ ÏúÑÍº¨Î¶¨ Î∞úÏÉù. Îß§ÎèÑÏÑ∏Ïóê Î∞ÄÎ¶∞ ÌùîÏ†ÅÏûÖÎãàÎã§.", trend: "ÌïòÎùΩ", stars: 3 },
            "HANGING_MAN": { name: "ÍµêÏàòÌòï", desc: "Í≥†Ï†êÏóêÏÑú Í∏¥ ÏïÑÎûòÍº¨Î¶¨ Î∞úÏÉù. Îß§ÎèÑÏÑ∏ Ï∂úÌòÑ Ïã†Ìò∏ÏûÖÎãàÎã§.", trend: "ÌïòÎùΩ", stars: 2 },
            "BEARISH_HARAMI": { name: "ÌïòÎùΩ ÏûâÌÉúÌòï", desc: "Í∏¥ ÏñëÎ¥â ÏïàÏóê ÏûëÏùÄ ÏùåÎ¥âÏù¥ Í∞áÌûå ÌòïÌÉú. ÏÉÅÏäπÏÑ∏Í∞Ä Î©àÏ∂îÍ≥† ÏûàÏäµÎãàÎã§.", trend: "ÌïòÎùΩ", stars: 2 },
            "BLACK_MARUBOZU": { name: "Ïû•ÎåÄ ÏùåÎ¥â", desc: "ÏúÑÏïÑÎûò Íº¨Î¶¨ ÏóÜÎäî Í∞ïÎ†•Ìïú ÌïòÎùΩÏÑ∏ÏûÖÎãàÎã§.", trend: "ÌïòÎùΩ", stars: 3 },

            // Ï§ëÎ¶Ω
            "DOJI": { name: "ÎèÑÏßÄÌòï", desc: "ÏãúÍ∞ÄÏôÄ Ï¢ÖÍ∞ÄÍ∞Ä ÏùºÏπò. Ï∂îÏÑ∏ Ï†ÑÌôòÏùò Ï†ÑÏ°∞Ïùº Ïàò ÏûàÏäµÎãàÎã§.", trend: "Ï§ëÎ¶Ω", stars: 1 },
            "SPINNING_TOP": { name: "ÌåΩÏù¥Ìòï", desc: "Î™∏ÌÜµÏù¥ ÏßßÍ≥† Íº¨Î¶¨Í∞Ä ÍπÅÎãàÎã§. Î∞©Ìñ•ÏÑ± ÌÉêÏÉâ Ï§ë.", trend: "Ï§ëÎ¶Ω", stars: 1 },
            "NONE": { name: "ÌäπÏù¥ Ìå®ÌÑ¥ ÏóÜÏùå", desc: "ÌòÑÏû¨ Î∂ÑÏÑùÎêú ÎöúÎ†∑Ìïú Ï∫îÎì§ Ìå®ÌÑ¥Ïù¥ ÏóÜÏäµÎãàÎã§.", trend: "Ï§ëÎ¶Ω", stars: 0 }
        };
        

        document.addEventListener('DOMContentLoaded', function () {
            const chartContainer = document.getElementById('tv_chart');
            const legendContainer = document.getElementById('chartLegend');
            const analysisSection = document.getElementById('analysisSection');
            const patternList = document.getElementById('patternList');
            
            // 1. Ï∞®Ìä∏ ÏÉùÏÑ±
            const chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: 600,
                layout: { backgroundColor: '#ffffff', textColor: '#333' },
                grid: { vertLines: { color: '#f0f3fa' }, horzLines: { color: '#f0f3fa' } },
                crosshair: { 
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: { labelVisible: true }, 
                    horzLine: { labelVisible: true }
                },
                rightPriceScale: {
                    visible: true,
                    borderColor: '#D1D4DC',
                    scaleMargins: { top: 0.05, bottom: 0.30 },
                },
                timeScale: { rightOffset: 12, barSpacing: 10, timeVisible: true, secondsVisible: false },
            });

            // 2. ÏãúÎ¶¨Ï¶à ÏÉùÏÑ±
            const candleSeries = chart.addCandlestickSeries({
                upColor: '#FF0000', borderUpColor: '#FF0000', wickUpColor: '#FF0000',
                downColor: '#0000FF', borderDownColor: '#0000FF', wickDownColor: '#0000FF',
                lastValueVisible: false, priceLineVisible: false // ÏÉÅÏûê Ï†úÍ±∞
            });

            const ma5Series = chart.addLineSeries({ color: '#2962FF', lineWidth: 1, lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });
            const ma20Series = chart.addLineSeries({ color: '#B71C1C', lineWidth: 2, lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });
            const ma60Series = chart.addLineSeries({ color: '#00C853', lineWidth: 2, lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });

            const volumeSeries = chart.addHistogramSeries({
                priceFormat: { type: 'volume' }, priceScaleId: 'vol_scale',
                lastValueVisible: false, priceLineVisible: false
            });

            chart.priceScale('vol_scale').applyOptions({ scaleMargins: { top: 0.75, bottom: 0 } });

            // --- Ï†ÑÏó≠ Î≥ÄÏàò ---
            let currentName = "ÏÇºÏÑ±Ï†ÑÏûê";
            let currentCode = "005930";
            let allData = [];
            let isLoading = false;

            // --- ‚≠êÔ∏è Ìå®ÌÑ¥ Î∂ÑÏÑù Î°úÎìú Ìï®Ïàò ---
            function loadAnalysis(code) {
                patternList.innerHTML = ''; // Ï¥àÍ∏∞Ìôî
                analysisSection.style.display = 'none';

                fetch(`/api/stock/${code}/analysis`)
                    .then(res => res.json())
                    .then(list => { 
                        analysisSection.style.display = 'block';
                        
                        if (!list || list.length === 0 || (list.length === 1 && list[0].type === 'NONE')) {
                            patternList.innerHTML = `<div style="color:#999; padding:10px;">Î∞úÍ≤¨Îêú ÌäπÏù¥ Ìå®ÌÑ¥Ïù¥ ÏóÜÏäµÎãàÎã§.</div>`;
                            return;
                        }

                        list.forEach(item => {
                            const def = PATTERN_DEFINITIONS[item.type] || PATTERN_DEFINITIONS["NONE"];
                            let badgeClass = 'trend-neutral';
                            let trendIcon = '-';
                            if (def.trend === 'ÏÉÅÏäπ') { badgeClass = 'trend-up'; trendIcon = '‚ñ≤ ÏÉÅÏäπ'; }
                            else if (def.trend === 'ÌïòÎùΩ') { badgeClass = 'trend-down'; trendIcon = '‚ñº ÌïòÎùΩ'; }

                            const stars = '‚òÖ'.repeat(def.stars) + '‚òÜ'.repeat(5 - def.stars);

                            const cardHtml = `
                                <div class="pattern-card">
                                    <div class="pattern-top">
                                        <span class="pattern-name">${def.name}</span>
                                        <span class="trend-badge ${badgeClass}">${trendIcon}</span>
                                    </div>
                                    <div class="pattern-desc">${def.desc}</div>
                                    <div class="pattern-meta">
                                        <span>Î∞úÏÉùÏùº: ${item.date}</span>
                                        <span class="reliability-stars" title="Ïã†Î¢∞ÎèÑ ${def.stars}/5">${stars}</span>
                                    </div>
                                </div>
                            `;
                            patternList.insertAdjacentHTML('beforeend', cardHtml);
                        });
                    })
                    .catch(err => console.error("Î∂ÑÏÑù Ïò§Î•ò:", err));
            }

         // --- ‚≠êÔ∏è [ÏàòÏ†ïÎê®] Ï†ïÎ≥¥ ÌëúÏãúÏ§Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (ÏïàÏ†ÑÌïú ÌååÏã± Ï†ÅÏö©) ---
            function updateLegend(param) {
                const validCrosshair = (param.time && param.point.x >= 0 && param.point.x <= chartContainer.clientWidth && param.point.y >= 0 && param.point.y <= chartContainer.clientHeight);
                
                // 1. Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Ï∞®Ìä∏ ÏúÑÎ©¥ seriesData, ÏïÑÎãàÎ©¥ allDataÏùò ÎßàÏßÄÎßâ Í∞í)
                const rawData = validCrosshair ? param.seriesData.get(candleSeries) : (allData.length > 0 ? allData[allData.length - 1] : null);
                const ma5Obj = validCrosshair ? param.seriesData.get(ma5Series) : (allData.length > 0 ? allData[allData.length - 1]?.ma5 : null);
                const ma20Obj = validCrosshair ? param.seriesData.get(ma20Series) : (allData.length > 0 ? allData[allData.length - 1]?.ma20 : null);
                const ma60Obj = validCrosshair ? param.seriesData.get(ma60Series) : (allData.length > 0 ? allData[allData.length - 1]?.ma60 : null);

                let html = `<span class="stock-title">${currentName} (${currentCode})</span>`;

                if (rawData) {
                    // ‚≠êÔ∏è [ÌïµÏã¨ ÏàòÏ†ï] Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§Ïóê Îî∞Îùº ÌïÑÎìúÎ™ÖÏù¥ Îã§Î•¥ÎØÄÎ°ú ÏïàÏ†ÑÌïòÍ≤å Ï∂îÏ∂ú
                    // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞Î©¥ .open, ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞Î©¥ .y[0] ÏÇ¨Ïö©
                    const open = (rawData.open !== undefined) ? rawData.open : rawData.y[0];
                    const high = (rawData.high !== undefined) ? rawData.high : rawData.y[1];
                    const low = (rawData.low !== undefined) ? rawData.low : rawData.y[2];
                    const close = (rawData.close !== undefined) ? rawData.close : rawData.y[3];

                    // Í∞íÏù¥ Ïú†Ìö®ÌïúÏßÄ ÌïúÎ≤à Îçî Ï≤¥ÌÅ¨ (ÏïàÏ†ÑÏû•Ïπò)
                    if (open !== undefined && close !== undefined) {
                        const colorClass = (close >= open) ? 'up' : 'down';
                        html += `
                            <div class="legend-item"><span class="legend-label">Ïãú:</span><span class="legend-value ${colorClass}">${Number(open).toLocaleString()}</span></div>
                            <div class="legend-item"><span class="legend-label">Í≥†:</span><span class="legend-value ${colorClass}">${Number(high).toLocaleString()}</span></div>
                            <div class="legend-item"><span class="legend-label">Ï†Ä:</span><span class="legend-value ${colorClass}">${Number(low).toLocaleString()}</span></div>
                            <div class="legend-item"><span class="legend-label">Ï¢Ö:</span><span class="legend-value ${colorClass}">${Number(close).toLocaleString()}</span></div>
                        `;
                    }
                }

                // ‚≠êÔ∏è MA Í∞í Ï∂îÏ∂ú Ìó¨Ìçº (Í∞ùÏ≤¥Î©¥ .value, Ïà´ÏûêÎ©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©)
                const getVal = (obj) => {
                    if (obj === undefined || obj === null) return null;
                    return (typeof obj === 'object' && 'value' in obj) ? obj.value : obj;
                };

                const v5 = getVal(ma5Obj);
                const v20 = getVal(ma20Obj);
                const v60 = getVal(ma60Obj);

                if (v5 !== null) html += `<div class="legend-item" style="color: #2962FF;"><span class="legend-label">MA5:</span><span class="legend-value">${Math.round(v5).toLocaleString()}</span></div>`;
                if (v20 !== null) html += `<div class="legend-item" style="color: #B71C1C;"><span class="legend-label">MA20:</span><span class="legend-value">${Math.round(v20).toLocaleString()}</span></div>`;
                if (v60 !== null) html += `<div class="legend-item" style="color: #00C853;"><span class="legend-label">MA60:</span><span class="legend-value">${Math.round(v60).toLocaleString()}</span></div>`;

                legendContainer.innerHTML = html;
            }

            chart.subscribeCrosshairMove(updateLegend);

            // --- Îç∞Ïù¥ÌÑ∞ Î°úÎî© ---
            function loadData(lastDate = null) {
                if (isLoading) return;
                isLoading = true;
                let url = `/api/stock/${currentCode}/candle-data`;
                if (lastDate) url += `?lastDate=${lastDate}`;

                fetch(url).then(res => res.json()).then(data => {
                    if (!Array.isArray(data) || data.length === 0) {
                        if (!lastDate && confirm(`[${currentName}] Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. ÏàòÏßëÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) collectData(currentCode);
                        isLoading = false; return;
                    }
                    if (lastDate === null) {
                        allData = data;
                        loadAnalysis(currentCode); // ‚≠êÔ∏è Ï¥àÍ∏∞ Î°úÎî© Ïãú Î∂ÑÏÑù Ïã§Ìñâ
                    } else {
                        allData = [...data, ...allData];
                    }
                    
                    updateChartSeries(allData);
                    // ‚≠êÔ∏è Ï§ëÏöî: Ï†úÎ™© Î∞è Îç∞Ïù¥ÌÑ∞ Í∞ïÏ†ú Í∞±Ïã† (Î≤ÑÍ∑∏ ÏàòÏ†ï)
                    updateLegend({ time: null, point: { x: -1, y: -1 } }); 
                    
                    isLoading = false;
                }).catch(err => { console.error(err); isLoading = false; });
            }

            function updateChartSeries(dataList) {
                const candles = dataList.map(d => ({ time: d.x, open: d.y[0], high: d.y[1], low: d.y[2], close: d.y[3] }));
                const ma5 = dataList.map(d => ({ time: d.x, value: d.ma5 })).filter(d => d.value);
                const ma20 = dataList.map(d => ({ time: d.x, value: d.ma20 })).filter(d => d.value);
                const ma60 = dataList.map(d => ({ time: d.x, value: d.ma60 })).filter(d => d.value);
                const volumes = dataList.map(d => ({ time: d.x, value: d.volume, color: (d.y[3] >= d.y[0]) ? 'rgba(255, 0, 0, 0.5)' : 'rgba(0, 0, 255, 0.5)' }));

                candleSeries.setData(candles);
                ma5Series.setData(ma5);
                ma20Series.setData(ma20);
                ma60Series.setData(ma60);
                volumeSeries.setData(volumes);
            }

            function collectData(code) {
                alert("ÏàòÏßë ÏãúÏûë...");
                fetch(`/api/collect/${code}`).then(() => {
                    let checkInterval = setInterval(() => {
                        fetch(`/api/stock/${code}/candle-data`).then(res => res.json()).then(data => {
                            if(data.length > 100) { clearInterval(checkInterval); loadData(null); }
                        });
                    }, 3000);
                });
            }

            chart.timeScale().subscribeVisibleLogicalRangeChange(logicalRange => {
                if (logicalRange !== null && logicalRange.from < 10 && !isLoading && allData.length > 0) loadData(allData[0].x);
            });

            const searchInput = document.getElementById('searchInput');
            const searchResult = document.getElementById('searchResult');
            searchInput.addEventListener('keyup', function() {
                const keyword = this.value.trim();
                if (keyword.length < 1) { searchResult.style.display = 'none'; return; }
                fetch(`/api/stock/search?keyword=${keyword}`).then(res => res.json()).then(list => {
                    searchResult.innerHTML = '';
                    if (list.length > 0) {
                        searchResult.style.display = 'block';
                        list.forEach(stock => {
                            const li = document.createElement('li');
                            li.textContent = `${stock.name} (${stock.code})`;
                            li.onclick = () => selectStock(stock.code, stock.name);
                            searchResult.appendChild(li);
                        });
                    } else { searchResult.style.display = 'none'; }
                });
            });

            function selectStock(code, name) {
                currentCode = code; currentName = name;
                searchInput.value = ''; searchResult.style.display = 'none';
                
                // ‚≠êÔ∏è Ï§ëÏöî: Ï†úÎ™© Ï¶âÏãú Í∞±Ïã† (ÏóêÎü¨ Î∞©ÏßÄ)
                updateLegend({ time: null, point: { x: -1, y: -1 } });
                
                allData = []; candleSeries.setData([]); ma5Series.setData([]); ma20Series.setData([]); volumeSeries.setData([]);
                
                loadData(null);
            }

            window.addEventListener('resize', () => { chart.resize(chartContainer.clientWidth, 600); });
            loadData(null);
        });
    </script>
</body>
</html>