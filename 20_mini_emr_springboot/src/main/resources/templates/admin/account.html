<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>계정 관리</title>
    <link type="text/css" th:href="@{/css/adminCommon.css}" rel="stylesheet">
    <link type="text/css" th:href="@{/css/adminAccount.css}" rel="stylesheet">
    
    <style>
        .modal { display: none; /* ... (기존 모달 스타일) ... */ }
        .btn { /* ... (기존 버튼 스타일) ... */ }
        .btn-danger { /* ... (기존 삭제 버튼 스타일) ... */ }
    </style>
</head>
<body>
    <nav class="sidebar">
        <h2>병원 관리 (ADMIN)</h2>
        <ul>
            <li><a href="/admin/">대시보드</a></li>
            <li><a href="/admin/accounts"><b>계정 관리</b></a></li>
            <li><a href="/admin/settings">병원 설정</a></li>
            <li><a href="/admin/schedules">스케줄 관리</a></li>
            <li><a href="/user/logout">로그아웃</a></li>
        </ul>
    </nav>
    <main class="content">
        <h1>계정 관리</h1>
        <p>병원의 접수직원(STAFF) 및 의사(DOCTOR) 계정을 관리합니다.</p>

        <button class="btn" onclick="openCreateModal()">
            ➕ 새 계정 발급
        </button>

        <table>
            <thead>
                <tr>
                    <th>로그인 ID (Username)</th>
                    <th>이름 (Name)</th>
                    <th>권한 (Role)</th>
                    <th>관리</th>
                </tr>
            </thead>
            
            <tbody>
                <tr th:each="account : ${accounts}">
                    <td th:text="${account.userName}"></td>
                    <td th:text="${account.name}"></td>
                    <td>
                        <span th:switch="${account.role}">
                            <span th:case="'DOCTOR'">의사</span>
                            <span th:case="'STAFF'">접수직원</span>
                            <span th:case="*">기타</span>
                        </span>
                    </td>
                    <td>
                        <button class="btn" 
                                th:data-userid="${account.userId}"
                                th:data-username="${account.userName}"
                                th:data-name="${account.name}"
                                th:data-role="${account.role}"
                                onclick="openUpdateModal(this)">
                            수정
                        </button>
                        <button class="btn btn-danger"
                                th:data-userid="${account.userId}"
                                th:data-username="${account.userName}"
                                onclick="deleteAccount(this)">
                            삭제
                        </button>
                    </td>
                </tr>
                
                <tr th:if="${#lists.isEmpty(accounts)}">
                    <td colspan="4" style="text-align: center;">등록된 계정이 없습니다.</td>
                </tr>
            </tbody>
        </table>
    </main>

    <div id="modal-create-form" class="modal">
        </div>
    
    <div id="modal-update-form" class="modal">
        <div class="modal-content">
            <h2>계정 수정</h2>
            <form id="updateAccountForm">
                <input type="hidden" id="update_userId" name="userId">
                
                <label for="update_userName">로그인 ID:</label>
                <input type="text" id="update_userName" name="id" readonly disabled>

                <label for="update_name">이름:</label>
                <input type="text" id="update_name" name="name" required>

                <label for="update_role">권한:</label>
                <select id="update_role" name="role" required>
                    <option value="">권한을 선택하세요...</option>
                    <option value="STAFF">접수직원 (STAFF)</option>
                    <option value="DOCTOR">의사 (DOCTOR)</option>
                </select>

                <button type="submit" class="btn">수정 완료</button>
                <button type="button" class="btn btn-danger" onclick="closeUpdateModal()">취소</button>
            </form>
        </div>
    </div>
    
    <script>
	    const createModal = document.getElementById('modal-create-form');
	    function openCreateModal() { createModal.style.display = 'flex'; }
	    function closeCreateModal() { createModal.style.display = 'none'; }
	
	    const updateModal = document.getElementById('modal-update-form');
	
	    // [수정] 'button' (this)을 파라미터로 받음
	    function openUpdateModal(button) {
	        var userId = button.dataset.userid;
	        var userName = button.dataset.username;
	        var name = button.dataset.name;
	        var role = button.dataset.role;
	
	        // 폼에 기존 데이터 채우기 (jQuery 사용)
	        $("#update_userId").val(userId);
	        $("#update_userName").val(userName);
	        $("#update_name").val(name);
	        $("#update_role").val(role); // ◀ role 값 채우기 추가
	
	        updateModal.style.display = 'flex';
	    }
	    function closeUpdateModal() {
	        updateModal.style.display = 'none';
	    }
	</script>
	
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	
    <script>
	    $(document).ready(function() {
	        // --- ID 중복 체크 (기존과 동일) ---
	        $("#userName").on("blur", function() {
                // (기존 idChk AJAX 코드...)
            });   

            // --- '새 계정' 폼 전송 (기존과 동일) ---
            $("#createAccountForm").on("submit", function(e) {
                // (기존 addUser AJAX 코드...)
            });
            
            // --- [추가] '계정 수정' 폼 전송 ---
            $("#updateAccountForm").on("submit", function(e) {
                e.preventDefault();
                
                var formData = {
                    userId: $("#update_userId").val(), // (PK)
                    name: $("#update_name").val(),
                    role: $("#update_role").val()
                    // (ID와 비밀번호는 이 폼에서 수정하지 않음)
                };
                
                $.ajax({
                    type: "POST", // (또는 PUT)
                    url: "/admin/accounts/update", // ◀ 컨트롤러에 이 URL이 필요
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function(response) {
                        alert(response.message || "계정이 수정되었습니다.");
                        closeUpdateModal();
                        location.reload();
                    },
                    error: function(xhr) {
                        alert(xhr.responseJSON.message || "수정에 실패했습니다.");
                    }
                });
            });

	    }); // <-- document.ready 끝
	
	    // [수정] '삭제' 함수 (URL 경로 수정)
	    function deleteAccount(button) {
	        var userId = button.dataset.userid;
	        var userName = button.dataset.username;
	
	        if (!confirm(userName + " 님을 정말 삭제하시겠습니까? (이 작업은 되돌릴 수 없습니다)")) {
	            return;
	        }
	
	        $.ajax({
	            type: "POST", // (또는 DELETE)
	            url: "/admin/accounts/delete", // ◀ 컨트롤러에 이 URL이 필요
	            contentType: "application/json",
	            data: JSON.stringify({ userId: userId }),
	            success: function(response) {
	                alert(response.message || "계정이 삭제되었습니다.");
	                location.reload();
	            },
	            error: function(xhr) {
	                alert(xhr.responseJSON.message || "삭제에 실패했습니다.");
	            }
	        });
	    }
	</script>
</body>
</html>